name: ğŸš€ CI & CD.
on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master
jobs:
  code-quality:
    name: "ğŸ”† Code Quality"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [12.x]
    steps:
      - name: ğŸ”½ Descargar proyecto
        uses: actions/checkout@v2
        with:
          persist-credential: false

      - name: ğŸ  Instalar Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node-version }}

      - name: ğŸ‘·â€â™‚ï¸ Instalar dependencias
        run: |
          npm i
      - name: ğŸ”… Sintaxis estÃ¡ndar prettier
        run: |
          echo "Recuerda tener instalado Prettier como formateador de cÃ³digo en tu Editor de texto"
          echo "Este cÃ³digo usarÃ¡ como estÃ¡ndar la indentaciÃ³n de Prettier."
          echo "Para solucionar tu indentaciÃ³n, ejecuta npm run sintax:fix"
          npm run sintax:test
      - name: ğŸ‘€ EstÃ¡ndares del proyecto
        run: |
          npm test
      - name: ğŸ‘€ Calidad del cÃ³digo
        run: |
          echo "Se revisarÃ¡ la calidad del cÃ³digo para que la consola no tenga warnings ni errores."
          echo "Se validarÃ¡ que no existan variables sin usar, console.logs, malos estÃ¡ndares de cÃ³digo, etc."
          npm run lint

  docker-push:
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/master' }}
    name: "ğŸ“¦ Docker build & push"
    needs: code-quality
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ‘·â€â™‚ï¸ Set up QEMU
        uses: docker/setup-qemu-action@v1

      - name: ğŸ‘·â€â™‚ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: ğŸ” Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      #- name: ğŸ· Get the version
      #  id: get_version
      #  run: |
      #    echo ::set-output name=VERSION::${GITHUB_REF#refs/tags/}

      - name: â˜ Build and push
        id: docker_build
        uses: docker/build-push-action@v2
        with:
          push: true
          tags: rmaafs/rmaafs-api:last-development
          #tags: rmaafs/rmaafs-api:${{ steps.get_version.outputs.VERSION }}
